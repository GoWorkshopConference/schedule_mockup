<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>改善されたワークショップスケジュール</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    .container {
      display: flex;
      justify-content: space-between;
    }

    .schedule-container {
      width: 75%;
      overflow-x: auto;
    }

    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 4px;
      text-align: center;
      height: 20px;
      box-sizing: border-box;
    }

    th {
      background-color: #f2f2f2;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .time-slot {
      width: 60px;
      position: sticky;
      left: 0;
      background-color: #fff;
      z-index: 5;
    }

    .workshop {
      background-color: #e6f3ff;
      cursor: pointer;
    }

    .break {
      background-color: #f0f0f0;
    }

    .lunch {
      background-color: #ffcccc;
    }

    .opening,
    .ending {
      background-color: #ccffcc;
    }

    .large-booth {
      background-color: #d4edda;
    }

    .selected {
      background-color: #ffeb3b;
    }

    #cart {
      width: 22%;
      background-color: white;
      border: 1px solid #ddd;
      padding: 10px;
      height: fit-content;
    }

    #cart h3 {
      margin-top: 0;
    }

    #cart-items {
      margin-bottom: 10px;
    }

    .cart-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .remove-item {
      color: red;
      cursor: pointer;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 100;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 500px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }

    #message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: #f8d7da;
      color: #721c24;
      padding: 10px;
      border-radius: 5px;
      display: none;
    }
  </style>
</head>

<body>
  <h1>ワークショップスケジュール</h1>
  <p>日付: <span id="current-date"></span></p>
  <div class="container">
    <div class="schedule-container">
      <table>
        <thead>
          <tr>
            <th class="time-slot">時間</th>
            <th class="large-booth">大ブース1</th>
            <th class="large-booth">大ブース2</th>
            <th class="large-booth">大ブース3</th>
            <th>ブース4</th>
            <th>ブース5</th>
            <th>ブース6</th>
            <th>ブース7</th>
            <th>ブース8</th>
            <th>ブース9</th>
            <th>ブース10</th>
          </tr>
        </thead>
        <tbody id="schedule-body">
          <!-- JavaScriptで動的に生成 -->
        </tbody>
      </table>
    </div>

    <div id="cart">
      <h3>選択中のワークショップ</h3>
      <div id="cart-items"></div>
      <button id="proceed-to-reservation">予約確認へ進む</button>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <div id="modal-content"></div>
    </div>
  </div>

  <div id="message"></div>

  <script>
    // 現在の日付を設定
    const currentDate = new Date();
    document.getElementById('current-date').textContent = currentDate.toLocaleDateString('ja-JP');

    // スケジュールデータ（修正版）
    const scheduleData = {
      "10:15": ["Workshop A (90min)", "", "", "Workshop D", "Workshop E", "Workshop F", "Workshop G", "Workshop H", "Workshop I", "Workshop J"],
      "11:45": ["Workshop B (90min)", "", "", "Workshop K", "Workshop L", "Workshop M", "Workshop N", "Workshop O", "Workshop P", "Workshop Q"],
      "13:30": ["Workshop C (90min)", "", "", "Workshop R", "Workshop S", "Workshop T", "Workshop U", "Workshop V", "Workshop W", "Workshop X"],
      "15:00": ["", "Workshop D (90min)", "", "Workshop Y", "Workshop Z", "Workshop AA", "Workshop AB", "Workshop AC", "Workshop AD", "Workshop AE"],
      "16:30": ["", "", "Workshop E (90min)", "Workshop AF", "Workshop AG", "Workshop AH", "Workshop AI", "Workshop AJ", "Workshop AK", "Workshop AL"]
    };

    // 選択されたワークショップを保存する配列
    let selectedWorkshops = [];

    // スケジュール表を生成
    const scheduleBody = document.getElementById('schedule-body');
    for (let hour = 9; hour < 18; hour++) {
      for (let minute = 0; minute < 60; minute += 15) {
        const row = document.createElement('tr');

        const timeCell = document.createElement('td');
        timeCell.textContent = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
        timeCell.classList.add('time-slot');
        row.appendChild(timeCell);

        if (hour === 10 && minute === 0) {
          const openingCell = document.createElement('td');
          openingCell.textContent = "オープニング";
          openingCell.classList.add('opening');
          openingCell.colSpan = 10;
          row.appendChild(openingCell);
        } else if (hour === 12 && minute === 30) {
          const lunchCell = document.createElement('td');
          lunchCell.textContent = "昼食休憩";
          lunchCell.classList.add('lunch');
          lunchCell.colSpan = 10;
          row.appendChild(lunchCell);
        } else if (hour === 17 && minute === 15) {
          const endingCell = document.createElement('td');
          endingCell.textContent = "エンディング";
          endingCell.classList.add('ending');
          endingCell.colSpan = 10;
          row.appendChild(endingCell);
        } else {
          const timeKey = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
          const workshops = scheduleData[timeKey] || Array(10).fill("");
          workshops.forEach((workshop, index) => {
            if (minute === 0 || (index < 3 && workshop)) {
              const cell = document.createElement('td');
              if (workshop) {
                cell.textContent = workshop;
                cell.classList.add('workshop');
                if (index < 3 && workshop.includes('(90min)')) {
                  cell.rowSpan = 6;
                  cell.classList.add('large-booth');
                }
                cell.onclick = () => openModal(workshop, timeKey, cell);
              }
              row.appendChild(cell);
            }
          });
        }

        scheduleBody.appendChild(row);
      }
    }

    function openModal(workshop, startTime, cell) {
      const modal = document.getElementById("modal");
      const modalContent = document.getElementById("modal-content");
      modalContent.innerHTML = `
                <h2>${workshop}</h2>
                <p>開始時刻: ${startTime}</p>
                <p>終了時刻: ${getEndTime(startTime, workshop.includes('(90min)') ? 90 : 45)}</p>
                <p>定員: ${Math.floor(Math.random() * 30) + 20}人</p>
                <p>現在の並んでいる人数: ${Math.floor(Math.random() * 30)}人</p>
                <p>溢れている人数: ${Math.floor(Math.random() * 10)}人</p>
                <button id="select-workshop">このワークショップを選択</button>
            `;

      modal.style.display = "block";

      document.getElementById("select-workshop").onclick = function () {
        selectWorkshop(workshop, startTime);
        modal.style.display = "none";
      };

      const span = document.getElementsByClassName("close")[0];
      span.onclick = function () {
        modal.style.display = "none";
      }

      window.onclick = function (event) {
        if (event.target == modal) {
          modal.style.display = "none";
        }
      }
    }

    function getEndTime(startTime, duration) {
      const [hours, minutes] = startTime.split(':').map(Number);
      const endDate = new Date(2024, 0, 1, hours, minutes + duration);
      return endDate.toTimeString().slice(0, 5);
    }

    function selectWorkshop(workshop, startTime) {
      const endTime = getEndTime(startTime, workshop.includes('(90min)') ? 90 : 45);
      if (isTimeConflict(startTime, endTime)) {
        showMessage("選択した時間帯に既に他のワークショップが選択されています。");
      } else {
        selectedWorkshops.push({ workshop, startTime, endTime });
        updateCart();
      }
    }

    function isTimeConflict(newStart, newEnd) {
      return selectedWorkshops.some(workshop => {
        return (newStart < workshop.endTime && workshop.startTime < newEnd);
      });
    }

    function showMessage(text) {
      const message = document.getElementById("message");
      message.textContent = text;
      message.style.display = "block";
      setTimeout(() => {
        message.style.display = "none";
      }, 3000);
    }

    function updateCart() {
      const cartItems = document.getElementById("cart-items");
      cartItems.innerHTML = "";

      // 時間順にソート
      selectedWorkshops.sort((a, b) => a.startTime.localeCompare(b.startTime));

      selectedWorkshops.forEach((workshop, index) => {
        const item = document.createElement("div");
        item.classList.add("cart-item");
        item.innerHTML = `
                    <span>${workshop.startTime} - ${workshop.endTime}: ${workshop.workshop}</span>
                    <span class="remove-item" data-index="${index}">×</span>
                `;
        cartItems.appendChild(item);
      });

      document.querySelectorAll(".remove-item").forEach(button => {
        button.onclick = function () {
          removeFromCart(parseInt(this.dataset.index));
        };
      });
    }

    function removeFromCart(index) {
      selectedWorkshops.splice(index, 1);
      updateCart();
    }

    document.getElementById("proceed-to-reservation").onclick = function () {
      if (selectedWorkshops.length === 0) {
        showMessage("ワークショップを選択してください。");
        return;
      }
      openReservationModal();
    };

    function openReservationModal() {
      const modal = document.getElementById("modal");
      const modalContent = document.getElementById("modal-content");
      modalContent.innerHTML = `
                <h2>予約確認</h2>
                <div id="reservation-summary"></div>
                <form id="reservation-form">
                    <label for="email">メールアドレス:</label>
                    <input type="email" id="email" required>
                    <button type="submit">予約を確定</button>
                </form>
            `;

      const summary = document.getElementById("reservation-summary");
      selectedWorkshops.forEach(w => {
        summary.innerHTML += `<p>${w.startTime} - ${w.endTime}: ${w.workshop}</p>`;
      });

      document.getElementById("reservation-form").onsubmit = function (e) {
        e.preventDefault();
        const email = document.getElementById("email").value;

        // ローカルストレージに予約情報を保存
        localStorage.setItem('reservations', JSON.stringify({
          email: email,
          workshops: selectedWorkshops
        }));

        showMessage("予約が完了しました。確認メールを送信しました（擬似的な処理です）。");

        // フォームをリセット
        this.reset();
        selectedWorkshops = [];
        updateCart();
        modal.style.display = "none";
      };

      modal.style.display = "block";
    }

    // ページ読み込み時に保存された予約情報を表示
    window.onload = function () {
      const savedReservations = localStorage.getItem('reservations');
      if (savedReservations) {
        const reservations = JSON.parse(savedReservations);
        console.log("保存された予約情報:", reservations);
        // ここで保存された予約情報を表示するUIを追加することができます
      }
      updateCart();
    }
  </script>
</body>

</html>
